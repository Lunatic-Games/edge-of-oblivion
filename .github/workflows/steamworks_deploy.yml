name: Build and Deploy to Steam

on:
  workflow_dispatch:
    inputs:
      build_description:
        description: Build Description
        required: true
        default: 'A generic build'
      linux:
        description: Build Linux
        type: boolean
        required: true
        default: true
      windows:
        description: Build Windows
        type: boolean
        required: true
        default: true
      dry_run:
        description: Dry Run (will not upload to steam if checked)
        type: boolean
        required: true
        default: false

jobs:
  build:
    name: Build game
    uses: ./.github/workflows/plug_godot_build.yml
    with:
      debug: false
      godot_version: "4.1"
      export_name: ${{ github.event.repository.name }} # Pretty name for distribution
      windows: ${{ inputs.windows }}
      windows_preset: Windows Desktop
      linux: ${{ inputs.linux }}
      linux_preset: Linux/X11
      project_path: '.'
      export_presets_path: '.'
      artifact_retention_days: 1
          
  deploy:
    if: ${{ !inputs.dry_run }}
    name: Deploy to Steam
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download windows artifacts
        if: ${{ inputs.windows }}
        uses: actions/download-artifact@v3.0.2
        with:
          name: windows-dist-${{ github.event.repository.name }}-${{ github.run_number }}
          path: build/windows
          
      - name: Download linux artifacts
        if: ${{ inputs.linux }}
        uses: actions/download-artifact@v3.0.2
        with:
          name: linux-dist-${{ github.event.repository.name }}-${{ github.run_number }}
          path: build/linux
          
      - name: Push to Steam
        uses: game-ci/steam-deploy@v3
        with:
          username: ${{ secrets.STEAM_USERNAME }}          
          configVdf: ${{ secrets.STEAM_CONFIG_VDF}}          
          appId: ${{ vars.STEAM_APP_ID }}
          buildDescription: ${{ github.event.inputs.build_description }}
          rootPath: build
          depot1Path: windows
          depot2Path: linux
          #releaseBranch: prerelease # Want to leave this disabled for testing
